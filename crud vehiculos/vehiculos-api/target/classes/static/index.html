<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>CRUD Vehículos</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 30px;
            background: #f5f5f5;
        }
        h1 {
            text-align: center;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        form {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px 20px;
            margin-bottom: 20px;
        }
        label {
            font-size: 0.9rem;
            font-weight: bold;
        }
        input {
            width: 100%;
            padding: 6px 8px;
            box-sizing: border-box;
        }
        button {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
        }
        #btnGuardar {
            background: #2563eb;
            color: white;
        }
        #btnLimpiar {
            background: #6b7280;
            color: white;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 6px 8px;
            text-align: left;
            font-size: 0.9rem;
        }
        th {
            background: #e5e7eb;
        }
        .acciones button {
            margin-right: 5px;
            font-size: 0.8rem;
        }
        .btn-editar {
            background: #16a34a;
            color: white;
        }
        .btn-eliminar {
            background: #dc2626;
            color: white;
        }
        .badge-id {
            font-size: 0.7rem;
            color: #6b7280;
        }
        #mensaje {
            margin-bottom: 10px;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>Gestión de Vehículos</h1>

    <div id="mensaje"></div>

    <!-- Formulario -->
    <form id="formVehiculo">
        <input type="hidden" id="vehiculoId">

        <div>
            <label for="placa">Placa</label>
            <input type="text" id="placa" required>
        </div>

        <div>
            <label for="marca">Marca</label>
            <input type="text" id="marca" required>
        </div>

        <div>
            <label for="modelo">Modelo</label>
            <input type="text" id="modelo" required>
        </div>

        <div>
            <label for="anio">Año</label>
            <input type="number" id="anio" required>
        </div>

        <div>
            <label for="color">Color</label>
            <input type="text" id="color" required>
        </div>

        <div style="display:flex; gap:8px; align-items:flex-end;">
            <button type="submit" id="btnGuardar">Guardar</button>
            <button type="button" id="btnLimpiar">Limpiar</button>
        </div>
    </form>

    <!-- Tabla -->
    <table>
        <thead>
        <tr>
            <th>Placa</th>
            <th>Marca</th>
            <th>Modelo</th>
            <th>Año</th>
            <th>Color</th>
            <th>Acciones</th>
        </tr>
        </thead>
        <tbody id="tbodyVehiculos">
        <!-- Aquí se llenan las filas -->
        </tbody>
    </table>
</div>

<script>
    const API_URL = "http://localhost:8080/api/vehiculos";

    const form = document.getElementById("formVehiculo");
    const vehiculoId = document.getElementById("vehiculoId");
    const placa = document.getElementById("placa");
    const marca = document.getElementById("marca");
    const modelo = document.getElementById("modelo");
    const anio = document.getElementById("anio");
    const color = document.getElementById("color");
    const tbody = document.getElementById("tbodyVehiculos");
    const mensaje = document.getElementById("mensaje");
    const btnGuardar = document.getElementById("btnGuardar");
    const btnLimpiar = document.getElementById("btnLimpiar");

    function mostrarMensaje(texto, tipo = "ok") {
        mensaje.textContent = texto;
        mensaje.style.color = tipo === "ok" ? "#16a34a" : "#dc2626";
        if (texto) {
            setTimeout(() => mensaje.textContent = "", 3000);
        }
    }

    async function cargarVehiculos() {
        try {
            const resp = await fetch(API_URL);
            if (!resp.ok) throw new Error("Error al obtener vehículos");
            const data = await resp.json();

            tbody.innerHTML = "";

            data.forEach(v => {
                const tr = document.createElement("tr");

                tr.innerHTML = `
                    <td>
                        ${v.placa}
                        <div class="badge-id">${v.id ? v.id : ""}</div>
                    </td>
                    <td>${v.marca}</td>
                    <td>${v.modelo}</td>
                    <td>${v.anio}</td>
                    <td>${v.color}</td>
                    <td class="acciones">
                        <button class="btn-editar">Editar</button>
                        <button class="btn-eliminar">Eliminar</button>
                    </td>
                `;

                const btnEditar = tr.querySelector(".btn-editar");
                const btnEliminar = tr.querySelector(".btn-eliminar");

                btnEditar.addEventListener("click", () => {
                    vehiculoId.value = v.id || "";
                    placa.value = v.placa || "";
                    marca.value = v.marca || "";
                    modelo.value = v.modelo || "";
                    anio.value = v.anio || "";
                    color.value = v.color || "";
                    btnGuardar.textContent = "Actualizar";
                });

                btnEliminar.addEventListener("click", async () => {
                    if (!v.id) {
                        mostrarMensaje("No se puede eliminar: id vacío", "error");
                        return;
                    }
                    if (!confirm("¿Seguro que quieres eliminar este vehículo?")) return;

                    try {
                        const respDel = await fetch(`${API_URL}/${v.id}`, {
                            method: "DELETE"
                        });
                        if (respDel.status === 204) {
                            mostrarMensaje("Vehículo eliminado");
                            await cargarVehiculos();
                        } else {
                            mostrarMensaje("Error al eliminar", "error");
                        }
                    } catch (e) {
                        mostrarMensaje("Error de red al eliminar", "error");
                    }
                });

                tbody.appendChild(tr);
            });

        } catch (e) {
            console.error(e);
            mostrarMensaje("No se pudo cargar la lista de vehículos", "error");
        }
    }

    form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const vehiculo = {
            placa: placa.value.trim(),
            marca: marca.value.trim(),
            modelo: modelo.value.trim(),
            anio: parseInt(anio.value, 10),
            color: color.value.trim()
        };

        if (!vehiculo.placa || !vehiculo.marca || !vehiculo.modelo || !vehiculo.anio || !vehiculo.color) {
            mostrarMensaje("Completa todos los campos", "error");
            return;
        }

        try {
            let resp;
            if (vehiculoId.value) {
                // UPDATE
                resp = await fetch(`${API_URL}/${vehiculoId.value}`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(vehiculo)
                });
            } else {
                // CREATE
                resp = await fetch(API_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(vehiculo)
                });
            }

            if (!resp.ok) {
                mostrarMensaje("Error al guardar el vehículo", "error");
                return;
            }

            limpiarFormulario();
            await cargarVehiculos();
            mostrarMensaje("Vehículo guardado correctamente");
        } catch (e) {
            console.error(e);
            mostrarMensaje("Error de red al guardar", "error");
        }
    });

    function limpiarFormulario() {
        vehiculoId.value = "";
        placa.value = "";
        marca.value = "";
        modelo.value = "";
        anio.value = "";
        color.value = "";
        btnGuardar.textContent = "Guardar";
    }

    btnLimpiar.addEventListener("click", () => {
        limpiarFormulario();
    });

    cargarVehiculos();
</script>
</body>
</html>
